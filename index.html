<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English 3 Speaking Milestone 3</title>
  <link rel="icon" href="icon-192.png">
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f6f6;color:#214;}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{color:#468283;margin:0 0 12px}
    .card{background:#fff;border:1px solid #e7e7e7;border-radius:12px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    #prompt{font-size:22px;line-height:1.5;margin:8px 0 12px}
    .meta{display:flex;gap:8px;align-items:center;color:#666;font-size:14px;margin-bottom:8px}
    #imgBox{display:none;text-align:center;margin-top:6px}
    #imgBox img{max-width:260px;max-height:160px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    #btn{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#84BD00;color:#fff;border:none;border-radius:10px;padding:12px 24px;font-size:20px;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer}
    #btn:active{transform:translateX(-50%) scale(.98)}
    #done{display:none;text-align:center;font-size:22px;color:#2a7}
  </style>
  <!-- تحميل الأسئلة الثابتة -->
  <script src="prompts.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>English 3 Speaking Milestone 3</h1>
    <div class="card">
      <div class="meta"><span id="counter">0 / 12</span></div>
      <div id="prompt">Tap “Start” to begin.</div>
      <div id="imgBox"><img id="pimg" alt="" /></div>
      <div id="done">You have finished.</div>
    </div>
  </div>

  <button id="btn">Start</button>

  <script>
    // ===== إعدادات عامة =====
    const bank = Array.isArray(window.prompts) ? window.prompts.slice(0, 12) : [];
    const btn   = document.getElementById('btn');
    const promptEl = document.getElementById('prompt');
    const counterEl = document.getElementById('counter');
    const imgBox = document.getElementById('imgBox');
    const pimg   = document.getElementById('pimg');
    const doneEl = document.getElementById('done');

    // قناة صوت واحدة — لا تداخل
    const player = new Audio();
    player.preload   = 'auto';
    player.playsInline = true;  // مهم للآيباد/آيفون

    let i = -1; // الفهرس الحالي (-1 قبل البداية)

    function updateCounter() {
      counterEl.textContent = `${Math.min(i+1, bank.length)} / ${bank.length}`;
    }

    function showPrompt(item) {
      promptEl.textContent = item.text || '';
      if (item.image) {
        pimg.src = item.image;
        imgBox.style.display = 'block';
      } else {
        imgBox.style.display = 'none';
        pimg.removeAttribute('src');
      }
    }

    function playAudioFor(item) {
      // إن كان الصوت مفقود، نُظهر Next مباشرة
      const src0 = item.audio || '';
      const src  = src0 && !/\.mp3$/i.test(src0) ? (src0 + '.mp3') : src0;

      // أوقف أي تشغيل سابق
      try { player.pause(); player.currentTime = 0; } catch(_) {}

      if (src) {
        player.src = src;
        const p = player.play();
        if (p && p.catch) p.catch(()=>{}); // iOS لو يحتاج تفاعل
      } else {
        // بدون صوت → نُظهر الزر مباشرة
        btn.disabled = false;
      }
    }

    // عند انتهاء الصوت → فعّل زر Next
    player.onended = () => { btn.disabled = false; };

    function next() {
      btn.disabled = true; // منع الدبل-كلك

      // أول ضغطة = ابدأ من 0
      if (i < 0) i = 0;
      else i = i + 1;

      // انتهينا؟
      if (i >= bank.length) {
        promptEl.style.display = 'none';
        imgBox.style.display = 'none';
        doneEl.style.display = 'block';
        btn.style.display = 'none';
        updateCounter();
        return;
      }

      // أعرض السؤال وشغّل صوته المطابق
      const item = bank[i];
      showPrompt(item);
      updateCounter();

      // “Start” لأول مرة، ثم “Next”
      btn.textContent = (i === 0 ? 'Next' : 'Next');

      playAudioFor(item);
    }

    // ——— زر البدء/التالي (أول تفاعل يفتح الصوت على iOS) ———
    btn.addEventListener('click', next, false);
    btn.addEventListener('pointerup', next, false);

    // لو صورة ناقصة (404) لا تخرب التخطيط
    pimg.addEventListener('error', () => { imgBox.style.display = 'none'; });

    // عند التحميل، حدّث العداد
    updateCounter();
  </script>
</body>
</html>
